name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 安装依赖
      run: npm ci
      
    - name: 代码格式检查
      run: npm run format -- --check
      
    - name: TypeScript 类型检查
      run: npm run type-check

  build:
    name: 构建测试
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20, 22]
        
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: 安装依赖
      run: npm ci
      
    - name: 构建项目
      run: npm run build
      
    - name: 上传构建产物
      if: matrix.node-version == '20'
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        retention-days: 7

  security:
    name: 安全扫描
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 安装依赖
      run: npm ci
      
    - name: 运行安全审计
      run: npm audit --audit-level=moderate
      
    - name: 依赖漏洞扫描
      run: npm audit --audit-level=high --production

  size-check:
    name: 包大小检查
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 设置 Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: 安装依赖
      run: npm ci
      
    - name: 构建项目
      run: npm run build
      
    - name: 分析包大小
      run: |
        echo "构建产物大小分析:"
        du -sh dist/
        find dist/ -name "*.js" -o -name "*.css" | head -10 | xargs ls -lh

  preview:
    name: 预览构建
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'pull_request'
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      
    - name: 下载构建产物
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist/
        
    - name: 部署到 GitHub Pages (预览)
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        destination_dir: pr-preview/${{ github.event.number }}
        
    - name: 评论预览链接
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `🚀 预览链接已准备就绪！\n\n📱 [查看预览](https://${context.repo.owner}.github.io/${context.repo.repo}/pr-preview/${context.issue.number}/)\n\n> 此预览链接将在PR合并后自动清理。`
          })